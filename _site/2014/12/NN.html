<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Digit Recognizer by Neural Network</title>
    <meta name="description" content="This blog power by Github and Jekyll.
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://dada889.github.io/2014/12/NN.html">
</head>


  <body>

    <header class="site-header">


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
                  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
                          });
</script>
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <div class="wrapper">

    <a class="site-title" href="/">Nothing About Data</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
          <a class="page-link" href="/Archive">Archive</a>
          <a class="page-link" href="/Categories">Categories</a>
	  <a class="page-link" href="/about">About</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Digit Recognizer by Neural Network</h1>
    <p class="post-meta">Dec 2, 2014</p>
  
    <ul class="tag_box inline">
      
      


  
     
    	<li><a href="/Tags#neural network-ref">neural network <span>1</span></a></li>
     
    	<li><a href="/Tags#machine learning-ref">machine learning <span>2</span></a></li>
     
    	<li><a href="/Tags#kaggle-ref">kaggle <span>1</span></a></li>
    
  




    </ul>
  
  </header>
  


  <article class="post-content">
    <h2 id="intorduction">Intorduction</h2>
<p>This algorithm is for a <a href="https://www.kaggle.com/c/digit-recognizer">kaggle competition</a> to take an image of a handwritten single digit, and determine what that digit is. The data used is <a href="https://www.kaggle.com/c/digit-recognizer/data">MNIST data</a>.</p>

<p>The data include 42000 image of hand-drawn digits. Each image is 28 pixels in height and 28 pixels in width, for a total of 784 pixels.</p>

<p>Let’s visualize some sample data:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">require</span><span class="p">(</span><span class="n">graphics</span><span class="p">)</span>

<span class="n">flip</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">xx</span><span class="o">=</span><span class="n">matrix</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="n">nrow</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">ncol</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">x</span><span class="p">))){</span>
    <span class="n">xx</span><span class="p">[</span><span class="n">i</span><span class="p">,]</span> <span class="o">=</span> <span class="n">rev</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,])}</span>
  <span class="k">return</span><span class="p">(</span><span class="n">xx</span><span class="p">)}</span>

<span class="n">sample_plot</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">xx</span> <span class="o">=</span> <span class="n">list</span><span class="p">()</span>
  <span class="n">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)),</span><span class="n">mar</span><span class="o">=</span><span class="n">rep</span><span class="p">(</span><span class="m">0.2</span><span class="p">,</span><span class="m">4</span><span class="p">))</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1</span><span class="o">:</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">as.numeric</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,])</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="m">28</span><span class="p">,</span><span class="m">28</span><span class="p">)</span>
    <span class="n">xx</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">flip</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
    <span class="n">image</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">xx</span><span class="p">[[</span><span class="n">i</span><span class="p">]],</span> <span class="n">col</span><span class="o">=</span><span class="n">gray.colors</span><span class="p">(</span><span class="m">12</span><span class="p">),</span><span class="n">xaxt</span><span class="o">=</span><span class="s1">'n'</span><span class="p">,</span><span class="n">yaxt</span><span class="o">=</span><span class="s1">'n'</span><span class="p">,</span><span class="n">ann</span><span class="o">=</span><span class="n">FALSE</span><span class="p">)</span>
  <span class="p">}}</span>

<span class="n">sample_p</span> <span class="o">&lt;-</span> <span class="n">read.csv</span><span class="p">(</span><span class="s2">"sample.csv"</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)[,</span><span class="m">-1</span><span class="p">]</span>
<span class="n">sample_p</span> <span class="o">=</span> <span class="n">sample_p</span><span class="p">[,</span><span class="m">-1</span><span class="p">]</span>
<span class="n">sample_plot</span><span class="p">(</span><span class="n">sample_p</span><span class="p">,</span><span class="m">16</span><span class="p">)</span></code></pre></figure>

<p><img src="/figure/source/2014-12-2-NN/unnamed-chunk-1-1.png" alt="plot of chunk unnamed-chunk-1" /></p>

<h2 id="neural-network-algorithm">Neural Network Algorithm</h2>

<h3 id="forward-propagation">Forward Propagation</h3>

<p>The model used is one level Artifical Neural Network(ANN). The superscript number in brack of each variable represent the level. In this model(one level ANN), 0 represent input level, 1 represent hidden level, 2 represent output level. $X^{(0)}$ is the raw data(a image of hand-drawn digit), a 1 row 784 columns matrix. $f_{\theta}(a)$ is a sigmoid function。$a$ hidden level variables，$z$ is the hidden level data and the output of sigmoid function ,$\Theta^{(l)}_0$ are the biased terms in input level and output level. $\widehat{Y}$ is the output and predicted values，a 1 row 10 columns matrix range between 0 and 1. When the maximum value lie in the third column, the prediction of the image would be 3.</p>

<script type="math/tex; mode=display">a^{(1)} = \Theta^{(1)}_0+X^{(0)}(\Theta^{(1)})^T</script>

<script type="math/tex; mode=display">z^{(1)} = f_{\theta}(a^{(1)})</script>

<script type="math/tex; mode=display">a^{(2)} = \Theta^{(2)}_0+z^{(1)}(\Theta^{(2)})^T</script>

<script type="math/tex; mode=display">\hat{Y} = f_{\theta}(a^{(2)})</script>

<p>Here is structure of one hidden layer  Neural Network(with 15 unit in the hidden layer):</p>

<p><img src="/figure/source/2014-12-2-NN/tikz12.png" alt="NN graph" /></p>

<h3 id="cost-function">Cost Function</h3>

<p>For classification problem, we use Cross-entropy cost function:</p>

<script type="math/tex; mode=display">J(\Theta)= -\frac{1}{2}  \left[  \sum^m_i \sum^{10}_k y^{(i)}_{k}log f_\theta (a^{(i)})_{k}  
  + (1-y^{(i)}_k ) log( 1- f_\theta (a^{(i)})_{k} )  \right]</script>

<p>or the simple version:</p>

<script type="math/tex; mode=display">J(\Theta)= -\frac{1}{m} \sum^m_i \sum^{10}_k y^{(i)}_{k}log f_\theta (a^{(i)})_{k}</script>

<h3 id="back-propagation">Back Propagation</h3>

<p>From the cost function $J(\Theta)$, we have the derivatives of $\Theta^{(1)}$ and $\Theta^{(2)}$:</p>

<script type="math/tex; mode=display">\frac{\partial J(\Theta)}{\partial \Theta^{(2)}} =  \frac{\partial f_{\theta}(a^{(2)})}{\partial a^{(2)}} \frac{\partial a^{(2)}}{\partial \Theta^{(2)}}</script>

<script type="math/tex; mode=display">\frac{\partial J(\Theta)}{\partial \Theta^{(2)}} =  (y-f_{\theta}(a^{(2)}))^Tz^{(1)}</script>

<script type="math/tex; mode=display">\frac{\partial J(\Theta)}{\partial \Theta^{(1)}} =  \frac{\partial f_{\theta}(a^{(2)})}{\partial a^{(2)}} \frac{\partial a^{(2)}}{\partial \Theta^{(2)}} \frac{\partial f_{\theta}(a^{(1)})}{\partial a^{(1)}} \frac{\partial a^{(1)}}{\partial \Theta^{(1)}}</script>

<script type="math/tex; mode=display">\frac{\partial J(\Theta)}{\partial \Theta^{(1)}} = \frac{\partial J(\Theta)}{\partial \Theta^{(2)}} \frac{\partial f_{\theta}(a^{(1)})}{\partial a^{(1)}} X^{(0)}</script>

<p>Here is the R code for the neural network. This model include 25 units in the hidden layer. $J(\Theta)$ can be minimize by gradient descent, called back-propagation in the setting.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">NN_cost</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">h_layer</span><span class="o">=</span><span class="m">25</span><span class="p">,</span> <span class="n">lambda</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">num_labels</span><span class="o">=</span><span class="m">10</span><span class="p">)</span> <span class="p">{</span>
  
  <span class="n">m</span> <span class="o">=</span> <span class="n">nrow</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="c1"># reshape Theta1 and Theta2
</span>  <span class="n">in_layer</span> <span class="o">=</span> <span class="n">ncol</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="n">par_t1</span> <span class="o">=</span> <span class="n">init</span><span class="p">[</span><span class="n">c</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="p">((</span><span class="n">in_layer</span><span class="m">+1</span><span class="p">)</span><span class="o">*</span><span class="n">h_layer</span><span class="p">))]</span>

  <span class="n">par_t2</span> <span class="o">=</span> <span class="n">init</span><span class="p">[</span><span class="n">c</span><span class="p">(((</span><span class="n">in_layer</span><span class="m">+1</span><span class="p">)</span><span class="o">*</span><span class="n">h_layer</span><span class="m">+1</span><span class="p">)</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="n">init</span><span class="p">))]</span>
  <span class="n">Theta1</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">par_t1</span><span class="p">,</span><span class="n">h_layer</span><span class="p">,</span><span class="n">in_layer</span><span class="m">+1</span><span class="p">)</span>
  <span class="n">Theta2</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">par_t2</span><span class="p">,</span><span class="n">num_labels</span><span class="p">,</span><span class="n">h_layer</span><span class="m">+1</span><span class="p">)</span>
  
  
  <span class="n">a1</span> <span class="o">=</span> <span class="n">cbind</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
  <span class="n">z2</span> <span class="o">=</span> <span class="n">a1</span><span class="o">%*%</span><span class="n">t</span><span class="p">(</span><span class="n">Theta1</span><span class="p">)</span>
  <span class="n">a2</span> <span class="o">=</span> <span class="n">cbind</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">z2</span><span class="p">))</span>
  <span class="n">z3</span> <span class="o">=</span> <span class="n">a2</span><span class="o">%*%</span><span class="n">t</span><span class="p">(</span><span class="n">Theta2</span><span class="p">)</span>
  <span class="n">h</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">z3</span><span class="p">)</span>
  
  <span class="n">ny</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">length</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="n">num_labels</span><span class="p">)</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="n">y</span><span class="p">)){</span>
    <span class="n">ny</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="m">1</span>
  <span class="p">}</span>
  
  <span class="n">regu</span> <span class="o">=</span> <span class="n">lambda</span><span class="o">*</span><span class="p">(</span><span class="n">sum</span><span class="p">(</span><span class="n">Theta1</span><span class="p">[,</span><span class="m">-1</span><span class="p">]</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="o">+</span><span class="n">sum</span><span class="p">(</span><span class="n">Theta2</span><span class="p">[,</span><span class="m">-1</span><span class="p">]</span><span class="o">^</span><span class="m">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="m">2</span><span class="o">*</span><span class="n">m</span><span class="p">)</span>
  <span class="n">cost</span> <span class="o">=</span> <span class="o">-</span><span class="n">sum</span><span class="p">(</span><span class="n">ny</span><span class="o">*</span><span class="n">log</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="n">ny</span><span class="p">)</span><span class="o">*</span><span class="n">log</span><span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="n">h</span><span class="p">))</span><span class="o">/</span><span class="n">m</span><span class="o">+</span><span class="n">regu</span>
  
  <span class="n">delta3</span> <span class="o">=</span> <span class="n">h</span><span class="o">-</span><span class="n">ny</span>
  <span class="n">delta2</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta3</span><span class="o">%*%</span><span class="n">Theta2</span><span class="p">[,</span><span class="m">-1</span><span class="p">])</span><span class="o">*</span><span class="n">sigmoidGradient</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span>
  
  <span class="n">thres1</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="n">nrow</span><span class="p">(</span><span class="n">Theta1</span><span class="p">),</span><span class="n">ncol</span><span class="p">(</span><span class="n">Theta1</span><span class="p">))</span>
  <span class="n">thres1</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span> <span class="o">=</span> <span class="m">0</span>
  <span class="n">thres2</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="n">nrow</span><span class="p">(</span><span class="n">Theta2</span><span class="p">),</span><span class="n">ncol</span><span class="p">(</span><span class="n">Theta2</span><span class="p">))</span>
  <span class="n">thres2</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span> <span class="o">=</span> <span class="m">0</span>
  
  <span class="n">Theta1_grad</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">delta2</span><span class="p">)</span><span class="o">%*%</span><span class="n">a1</span><span class="p">)</span><span class="o">/</span><span class="n">m</span> <span class="o">+</span> <span class="n">thres1</span><span class="o">*</span><span class="n">Theta1</span><span class="o">*</span><span class="n">lambda</span><span class="o">/</span><span class="n">m</span>
  <span class="n">Theta2_grad</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">delta3</span><span class="p">)</span><span class="o">%*%</span><span class="n">a2</span><span class="p">)</span><span class="o">/</span><span class="n">m</span> <span class="o">+</span> <span class="n">thres2</span><span class="o">*</span><span class="n">Theta2</span><span class="o">*</span><span class="n">lambda</span><span class="o">/</span><span class="n">m</span>
  
  <span class="n">result</span> <span class="o">=</span> <span class="n">list</span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="n">cost</span><span class="p">,</span><span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span><span class="n">grad</span><span class="o">=</span><span class="n">list</span><span class="p">(</span><span class="n">t1</span><span class="o">=</span><span class="n">Theta1_grad</span><span class="p">,</span><span class="n">t2</span><span class="o">=</span><span class="n">Theta2_grad</span><span class="p">))</span>
  <span class="k">return</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<h2 id="train-the-model">Train The Model</h2>

<p>First, we randomly select 70% of data as training data set.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">data_all</span> <span class="o">&lt;-</span> <span class="n">read.csv</span><span class="p">(</span><span class="s2">"train.csv"</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span>
<span class="n">train_size</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="m">0.7</span><span class="o">*</span><span class="n">nrow</span><span class="p">(</span><span class="n">data_all</span><span class="p">))</span>
<span class="n">train_indx</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="n">seq_len</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">data_all</span><span class="p">)),</span> <span class="n">size</span> <span class="o">=</span> <span class="n">train_size</span><span class="p">)</span></code></pre></figure>

<p>Preprocess and normalize data.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">data</span> <span class="o">=</span> <span class="n">data_all</span><span class="p">[</span><span class="n">train_indx</span><span class="p">,]</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">data</span><span class="p">[,</span><span class="m">-1</span><span class="p">]</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">data.matrix</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">$</span><span class="n">label</span>
<span class="n">y</span><span class="o">=</span><span class="n">replace</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">y</span><span class="o">==</span><span class="m">0</span><span class="p">,</span><span class="m">10</span><span class="p">)</span>
<span class="n">train_nl</span> <span class="o">=</span> <span class="p">(</span><span class="n">train</span><span class="m">-125</span><span class="p">)</span><span class="o">/</span><span class="m">255</span></code></pre></figure>

<p>Build up the initial value and training variables.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">h_layer</span><span class="o">=</span><span class="m">25</span>
<span class="n">t1_epsilon</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="m">6</span><span class="p">)</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ncol</span><span class="p">(</span><span class="n">train</span><span class="p">)</span><span class="o">+</span><span class="n">h_layer</span><span class="p">)</span>
<span class="n">t2_epsilon</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="m">6</span><span class="p">)</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h_layer</span><span class="m">+10</span><span class="p">)</span>
<span class="n">t1_random</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">runif</span><span class="p">((</span><span class="n">ncol</span><span class="p">(</span><span class="n">train</span><span class="p">)</span><span class="m">+1</span><span class="p">)</span><span class="o">*</span><span class="m">25</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="m">25</span><span class="p">,(</span><span class="n">ncol</span><span class="p">(</span><span class="n">train</span><span class="p">)</span><span class="m">+1</span><span class="p">))</span>
<span class="n">t2_random</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">runif</span><span class="p">(</span><span class="m">26</span><span class="o">*</span><span class="m">10</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="m">10</span><span class="p">,</span><span class="m">26</span><span class="p">)</span>
<span class="n">t1_random</span> <span class="o">=</span> <span class="n">t1_random</span><span class="o">*</span><span class="m">2</span><span class="o">*</span><span class="n">t1_epsilon</span> <span class="o">-</span> <span class="n">t1_epsilon</span>
<span class="n">t2_random</span> <span class="o">=</span> <span class="n">t2_random</span><span class="o">*</span><span class="m">2</span><span class="o">*</span><span class="n">t2_epsilon</span> <span class="o">-</span> <span class="n">t2_epsilon</span>
<span class="n">ini</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">as.vector</span><span class="p">(</span><span class="n">t1_random</span><span class="p">),</span><span class="n">as.vector</span><span class="p">(</span><span class="n">t2_random</span><span class="p">))</span>
<span class="n">lambda</span><span class="o">=</span><span class="m">1</span>
<span class="n">costFunction</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">NN_cost</span><span class="p">(</span><span class="n">train_nl</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">lambda</span><span class="o">=</span><span class="n">lambda</span><span class="p">)</span>
  <span class="n">J</span> <span class="o">=</span> <span class="n">result</span><span class="o">$</span><span class="n">cost</span>
  <span class="n">grad</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">as.vector</span><span class="p">(</span><span class="n">result</span><span class="o">$</span><span class="n">grad</span><span class="o">$</span><span class="n">t1</span><span class="p">),</span><span class="n">as.vector</span><span class="p">(</span><span class="n">result</span><span class="o">$</span><span class="n">grad</span><span class="o">$</span><span class="n">t2</span><span class="p">))</span>
  <span class="n">grad</span> <span class="o">=</span> <span class="n">as.matrix</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span><span class="n">length</span><span class="p">(</span><span class="n">grad</span><span class="p">),</span><span class="m">1</span><span class="p">)</span>
  <span class="k">return</span><span class="p">(</span><span class="n">list</span><span class="p">(</span><span class="n">J</span><span class="o">=</span><span class="n">J</span><span class="p">,</span><span class="n">grad</span><span class="o">=</span><span class="n">grad</span><span class="p">))</span>
<span class="p">}</span></code></pre></figure>

<p>Optimize the model</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">optimization</span> <span class="o">=</span> <span class="n">fmincg</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">costFunction</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">par</span><span class="p">,</span> <span class="n">Maxiter</span><span class="o">=</span><span class="m">500</span><span class="p">)</span></code></pre></figure>

<p>At the end, I use $fmincg$ function to do the optimization. Because $fmincg$ function is more efficient than my own gradient decent function. $fmincg$ is one of the optimization function Andrew Ng used in his online course <a href="https://www.coursera.org/course/ml">Machine Learning</a>. This function was original written in Matlab, I rewrite it into R. Here are the R code for $fmincg$ function.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">fmincg</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">X</span><span class="p">,</span> <span class="n">Maxiter</span><span class="o">=</span><span class="m">10</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">length</span> <span class="o">=</span> <span class="n">Maxiter</span>
  <span class="n">RHO</span> <span class="o">=</span> <span class="m">0.01</span> 
  <span class="n">SIG</span> <span class="o">=</span> <span class="m">0.5</span>  
  <span class="n">INT</span> <span class="o">=</span> <span class="m">0.1</span>  
  <span class="n">EXT</span> <span class="o">=</span> <span class="m">3.0</span>  
  <span class="n">MAX</span> <span class="o">=</span> <span class="m">20</span>   
  <span class="n">RATIO</span> <span class="o">=</span> <span class="m">100</span>
  <span class="n">red</span> <span class="o">=</span> <span class="m">1</span>
  
  <span class="n">i</span> <span class="o">=</span> <span class="m">0</span>
  <span class="n">ls_failed</span> <span class="o">=</span> <span class="m">0</span>
  <span class="n">fX</span> <span class="o">=</span> <span class="n">numeric</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
  <span class="n">eval</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
  <span class="n">f1</span> <span class="o">=</span> <span class="n">eval</span><span class="o">$</span><span class="n">J</span>
  <span class="n">df1</span> <span class="o">=</span> <span class="n">eval</span><span class="o">$</span><span class="n">grad</span>
  <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span><span class="o">&lt;</span><span class="m">0</span><span class="p">)</span>
  <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">df1</span>
  <span class="n">d1</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="p">)</span><span class="o">%*%</span><span class="n">s</span>
  <span class="n">z1</span> <span class="o">=</span> <span class="n">red</span><span class="o">/</span><span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="n">d1</span><span class="p">)</span>
  
  <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">abs</span><span class="p">(</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span><span class="o">&gt;</span><span class="m">0</span><span class="p">)</span>
    <span class="n">X0</span> <span class="o">=</span> <span class="n">X</span><span class="p">;</span> <span class="n">f0</span> <span class="o">=</span> <span class="n">f1</span><span class="p">;</span> <span class="n">df0</span> <span class="o">=</span> <span class="n">df1</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="n">z1</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="o">*</span><span class="n">s</span>
    <span class="n">eval</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">eval</span><span class="o">$</span><span class="n">J</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">eval</span><span class="o">$</span><span class="n">grad</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span><span class="o">&lt;</span><span class="m">0</span><span class="p">)</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span><span class="o">%*%</span><span class="n">s</span><span class="p">;</span>
    <span class="n">f3</span> <span class="o">=</span> <span class="n">f1</span><span class="p">;</span> <span class="n">d3</span> <span class="o">=</span> <span class="n">d1</span><span class="p">;</span> <span class="n">z3</span> <span class="o">=</span> <span class="o">-</span><span class="n">z1</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">length</span><span class="o">&gt;</span><span class="m">0</span><span class="p">){</span><span class="n">M</span><span class="o">=</span><span class="n">MAX</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="n">M</span><span class="o">=</span><span class="n">min</span><span class="p">(</span><span class="n">MAX</span><span class="p">,</span><span class="o">-</span><span class="n">length</span><span class="o">-</span><span class="n">i</span><span class="p">)}</span>
    <span class="n">success</span> <span class="o">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">limit</span> <span class="o">=</span> <span class="m">-1</span><span class="p">;</span> 
    <span class="k">while</span><span class="p">(</span><span class="m">1</span><span class="p">){</span>
      <span class="k">while</span><span class="p">(((</span><span class="n">f2</span> <span class="o">&gt;</span> <span class="n">f1</span><span class="o">+</span><span class="n">z1</span><span class="o">*</span><span class="n">RHO</span><span class="o">*</span><span class="n">d1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">d2</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">SIG</span><span class="o">*</span><span class="n">d1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">M</span> <span class="o">&gt;</span> <span class="m">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="n">z1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">f2</span> <span class="o">&gt;</span> <span class="n">f1</span><span class="p">){</span>
          <span class="n">z2</span> <span class="o">=</span> <span class="n">z3</span> <span class="o">-</span> <span class="p">(</span><span class="m">0.5</span><span class="o">*</span><span class="n">d3</span><span class="o">*</span><span class="n">z3</span><span class="o">*</span><span class="n">z3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">d3</span><span class="o">*</span><span class="n">z3</span><span class="o">+</span><span class="n">f2</span><span class="o">-</span><span class="n">f3</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">A</span> <span class="o">=</span> <span class="m">6</span><span class="o">*</span><span class="p">(</span><span class="n">f2</span><span class="o">-</span><span class="n">f3</span><span class="p">)</span><span class="o">/</span><span class="n">z3</span><span class="m">+3</span><span class="o">*</span><span class="p">(</span><span class="n">d2</span><span class="o">+</span><span class="n">d3</span><span class="p">)</span>                                
          <span class="n">B</span> <span class="o">=</span> <span class="m">3</span><span class="o">*</span><span class="p">(</span><span class="n">f3</span><span class="o">-</span><span class="n">f2</span><span class="p">)</span><span class="o">-</span><span class="n">z3</span><span class="o">*</span><span class="p">(</span><span class="n">d3</span><span class="m">+2</span><span class="o">*</span><span class="n">d2</span><span class="p">)</span>
          <span class="n">z2</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="n">B</span><span class="o">-</span><span class="n">A</span><span class="o">*</span><span class="n">d2</span><span class="o">*</span><span class="n">z3</span><span class="o">*</span><span class="n">z3</span><span class="p">)</span><span class="o">-</span><span class="n">B</span><span class="p">)</span><span class="o">/</span><span class="n">A</span><span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is.na</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span><span class="o">|</span><span class="n">is.infinite</span><span class="p">(</span><span class="n">z2</span><span class="p">)){</span><span class="n">z2</span> <span class="o">=</span> <span class="n">z3</span><span class="o">/</span><span class="m">2</span><span class="p">}</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">z2</span><span class="p">,</span> <span class="n">INT</span><span class="o">*</span><span class="n">z3</span><span class="p">),(</span><span class="m">1</span><span class="o">-</span><span class="n">INT</span><span class="p">)</span><span class="o">*</span><span class="n">z3</span><span class="p">)</span>
        <span class="n">z1</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">+</span> <span class="n">z2</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="n">z2</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="o">*</span><span class="n">s</span>
        <span class="n">eval</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">eval</span><span class="o">$</span><span class="n">J</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">eval</span><span class="o">$</span><span class="n">grad</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">M</span> <span class="o">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span><span class="o">&lt;</span><span class="m">0</span><span class="p">)</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span><span class="o">%*%</span><span class="n">s</span>
        <span class="n">z3</span> <span class="o">=</span> <span class="n">z3</span> <span class="o">-</span> <span class="n">z2</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">f2</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">f1</span><span class="o">+</span><span class="n">z1</span><span class="o">*</span><span class="n">RHO</span><span class="o">*</span><span class="n">d1</span><span class="p">)</span> <span class="o">|</span> <span class="n">d2</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">SIG</span><span class="o">*</span><span class="n">d1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">break</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d2</span> <span class="o">&gt;</span> <span class="n">SIG</span><span class="o">*</span><span class="n">d1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">success</span> <span class="o">=</span> <span class="m">1</span><span class="p">;</span> <span class="k">break</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">M</span> <span class="o">==</span><span class="m">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">break</span>
      <span class="p">}</span>
      <span class="n">A</span> <span class="o">=</span> <span class="m">6</span><span class="o">*</span><span class="p">(</span><span class="n">f2</span><span class="o">-</span><span class="n">f3</span><span class="p">)</span><span class="o">/</span><span class="n">z3</span><span class="m">+3</span><span class="o">*</span><span class="p">(</span><span class="n">d2</span><span class="o">+</span><span class="n">d3</span><span class="p">)</span>
      <span class="n">B</span> <span class="o">=</span> <span class="m">3</span><span class="o">*</span><span class="p">(</span><span class="n">f3</span><span class="o">-</span><span class="n">f2</span><span class="p">)</span><span class="o">-</span><span class="n">z3</span><span class="o">*</span><span class="p">(</span><span class="n">d3</span><span class="m">+2</span><span class="o">*</span><span class="n">d2</span><span class="p">)</span>
      <span class="n">z2</span> <span class="o">=</span> <span class="o">-</span><span class="n">d2</span><span class="o">*</span><span class="n">z3</span><span class="o">*</span><span class="n">z3</span><span class="o">/</span><span class="p">(</span><span class="n">B</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="n">B</span><span class="o">-</span><span class="n">A</span><span class="o">*</span><span class="n">d2</span><span class="o">*</span><span class="n">z3</span><span class="o">*</span><span class="n">z3</span><span class="p">))</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">is.na</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span><span class="o">|</span><span class="n">is.infinite</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span><span class="o">|</span><span class="n">z2</span><span class="o">&lt;</span><span class="m">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;</span><span class="m">-0.5</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">z2</span> <span class="o">=</span> <span class="n">z1</span><span class="o">*</span><span class="p">(</span><span class="n">EXT</span><span class="m">-1</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">z2</span> <span class="o">=</span> <span class="p">(</span><span class="n">limit</span><span class="o">-</span><span class="n">z1</span><span class="p">)</span><span class="o">/</span><span class="m">2</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">limit</span> <span class="o">&gt;</span> <span class="m">-0.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">z2</span><span class="o">+</span><span class="n">z1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">)){</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="p">(</span><span class="n">limit</span><span class="o">-</span><span class="n">z1</span><span class="p">)</span><span class="o">/</span><span class="m">2</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">limit</span> <span class="o">&lt;</span> <span class="m">-0.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">z2</span><span class="o">+</span><span class="n">z1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">z1</span><span class="o">*</span><span class="n">EXT</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="n">z1</span><span class="o">*</span><span class="p">(</span><span class="n">EXT</span><span class="m">-1</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">z2</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">-</span><span class="n">z3</span><span class="o">*</span><span class="n">INT</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="o">-</span><span class="n">z3</span><span class="o">*</span><span class="n">INT</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">limit</span> <span class="o">&gt;</span> <span class="m">-0.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">z2</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">limit</span><span class="o">-</span><span class="n">z1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="m">1.0</span><span class="o">-</span><span class="n">INT</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="p">(</span><span class="n">limit</span> <span class="o">-</span> <span class="n">z1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="m">1</span> <span class="o">-</span> <span class="n">INT</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="n">f3</span> <span class="o">=</span> <span class="n">f2</span><span class="p">;</span> <span class="n">d3</span> <span class="o">=</span> <span class="n">d2</span><span class="p">;</span> <span class="n">z3</span> <span class="o">=</span> <span class="o">-</span><span class="n">z2</span><span class="p">;</span> 
      <span class="n">z1</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">+</span> <span class="n">z2</span><span class="p">;</span> <span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="n">z2</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="o">*</span><span class="n">s</span><span class="p">;</span>
      <span class="n">eval</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
      <span class="n">f2</span> <span class="o">=</span> <span class="n">eval</span><span class="o">$</span><span class="n">J</span>
      <span class="n">df2</span> <span class="o">=</span> <span class="n">eval</span><span class="o">$</span><span class="n">grad</span>
      <span class="n">M</span> <span class="o">=</span> <span class="n">M</span> <span class="o">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span><span class="o">&lt;</span><span class="m">0</span><span class="p">)</span>
      <span class="n">d2</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span><span class="o">%*%</span><span class="n">s</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">f1</span> <span class="o">=</span> <span class="n">f2</span><span class="p">;</span> <span class="n">fX</span> <span class="o">=</span> <span class="n">rbind</span><span class="p">(</span><span class="n">fX</span><span class="p">,</span> <span class="n">f1</span><span class="p">)</span>
      <span class="n">print</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="s1">'Iteration  '</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s1">'| Cost:'</span><span class="p">,</span><span class="n">f1</span><span class="p">))</span>
      <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span><span class="o">%*%</span><span class="n">df2</span><span class="o">-</span><span class="n">t</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span><span class="o">%*%</span><span class="n">df2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span><span class="o">%*%</span><span class="n">df1</span><span class="p">)</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="o">*</span><span class="n">s</span> <span class="o">-</span> <span class="n">df2</span>
      <span class="n">tmp</span> <span class="o">=</span> <span class="n">df1</span><span class="p">;</span> <span class="n">df1</span> <span class="o">=</span> <span class="n">df2</span><span class="p">;</span> <span class="n">df2</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
      <span class="n">d2</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span><span class="o">%*%</span><span class="n">s</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">d2</span><span class="o">&gt;</span><span class="m">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">df1</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="o">-</span><span class="n">t</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">%*%</span><span class="n">s</span>
      <span class="p">}</span>
      <span class="n">z1</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">*</span> <span class="n">min</span><span class="p">(</span><span class="n">RATIO</span><span class="p">,</span> <span class="n">d1</span><span class="o">/</span><span class="p">(</span><span class="n">d2</span><span class="m">-2.2251e-308</span><span class="p">))</span>
      <span class="n">d1</span> <span class="o">=</span> <span class="n">d2</span>
      <span class="n">ls_failed</span> <span class="o">=</span> <span class="m">0</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">X</span> <span class="o">=</span> <span class="n">X0</span><span class="p">;</span> <span class="n">f1</span> <span class="o">=</span> <span class="n">f0</span><span class="p">;</span> <span class="n">df1</span> <span class="o">=</span> <span class="n">df0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ls_failed</span><span class="o">|</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">abs</span><span class="p">(</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">break</span>
      <span class="p">}</span>
      <span class="n">tmp</span> <span class="o">=</span> <span class="n">df1</span><span class="p">;</span> <span class="n">df1</span> <span class="o">=</span> <span class="n">df2</span><span class="p">;</span> <span class="n">df2</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
      <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">df1</span>
      <span class="n">d1</span> <span class="o">=</span> <span class="o">-</span><span class="n">t</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">%*%</span><span class="n">s</span>
      <span class="n">z1</span> <span class="o">=</span> <span class="m">1</span><span class="o">/</span><span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="n">d1</span><span class="p">)</span>
      <span class="n">ls_failed</span> <span class="o">=</span> <span class="m">1</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">(</span><span class="n">list</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="n">X</span><span class="p">,</span><span class="n">cost</span><span class="o">=</span><span class="n">fX</span><span class="p">))</span>
<span class="p">}</span></code></pre></figure>

<h2 id="training-result">Training Result</h2>

<p>The result is achieve by training this model with 29400 data in 200000 iteration.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">first_try</span> <span class="o">=</span> <span class="n">fmincg</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">costFunction</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">ini</span><span class="p">,</span> <span class="n">Maxiter</span><span class="o">=</span><span class="m">200000</span><span class="p">)</span></code></pre></figure>

<p>$ckeck_accurate$ function is build up to check the accurate of my model ues testing data set and validation data set.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">check_accurate</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">h_layer</span><span class="o">=</span><span class="m">25</span><span class="p">,</span><span class="n">lambda</span><span class="p">,</span><span class="n">num_labels</span><span class="o">=</span><span class="m">10</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">fit_model</span> <span class="o">=</span> <span class="n">NN_cost</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">init</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">h_layer</span><span class="p">,</span><span class="n">lambda</span><span class="o">=</span><span class="n">lambda</span><span class="p">,</span><span class="n">num_labels</span><span class="p">)</span>
  <span class="n">fit_matirx</span> <span class="o">=</span> <span class="n">fit_model</span><span class="o">$</span><span class="n">h</span>
  <span class="n">fit_values</span> <span class="o">=</span> <span class="n">apply</span><span class="p">(</span><span class="n">fit_matirx</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="n">which.max</span><span class="p">)</span>
  <span class="n">fit_values</span> <span class="o">=</span> <span class="n">as.vector</span><span class="p">(</span><span class="n">fit_values</span><span class="p">)</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">as.vector</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
  <span class="n">accurate</span> <span class="o">=</span> <span class="n">sum</span><span class="p">(</span><span class="n">fit_values</span><span class="o">==</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="n">length</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">list</span><span class="p">(</span><span class="n">fit</span> <span class="o">=</span> <span class="n">fit_values</span><span class="p">,</span> <span class="n">acu</span> <span class="o">=</span> <span class="n">accurate</span><span class="p">)</span>
  <span class="k">return</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<p>The rest of the data is been seperate as test set and validate set</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">test_valid_data</span> <span class="o">=</span> <span class="n">data_all</span><span class="p">[</span><span class="o">-</span><span class="n">train_indx</span><span class="p">,]</span>
<span class="n">test_size</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="m">0.7</span><span class="o">*</span><span class="n">nrow</span><span class="p">(</span><span class="n">test_valid_data</span><span class="p">))</span>
<span class="n">test_ind</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="n">seq_len</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">test_valid_data</span><span class="p">)),</span> <span class="n">size</span> <span class="o">=</span> <span class="n">test_size</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">test_valid_data</span><span class="p">[</span><span class="n">test_ind</span><span class="p">,]</span>
<span class="n">valid_data</span> <span class="o">=</span> <span class="n">test_valid_data</span><span class="p">[</span><span class="o">-</span><span class="n">test_ind</span><span class="p">,]</span></code></pre></figure>

<p>Setting up the test set and ckeck the accurate.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">test</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[,</span><span class="m">-1</span><span class="p">]</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">data.matrix</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
<span class="n">test_y</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">$</span><span class="n">label</span>
<span class="n">test_y</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">test_y</span><span class="p">,</span><span class="n">test_y</span><span class="o">==</span><span class="m">0</span><span class="p">,</span><span class="m">10</span><span class="p">)</span>
<span class="n">test_nl</span> <span class="o">=</span> <span class="p">(</span><span class="n">test</span><span class="m">-125</span><span class="p">)</span><span class="o">/</span><span class="m">255</span>

<span class="n">test_accurate</span> <span class="o">=</span> <span class="n">check_accurate</span><span class="p">(</span><span class="n">test_nl</span><span class="p">,</span><span class="n">test_y</span><span class="p">,</span><span class="n">par</span><span class="p">,</span><span class="n">lambda</span><span class="o">=</span><span class="n">lambda</span><span class="p">)</span>
<span class="n">test_accurate</span><span class="o">$</span><span class="n">acu</span></code></pre></figure>

<h2 id="refference">Refference</h2>
<ul>
  <li><a href="https://www.coursera.org/course/ml">Stanford University Machine Learning online course</a></li>
  <li>The Elements of Statistical Learning, Data Mining, Inference, and Prediction</li>
  <li>Machine Learning An Algorithmic Perspective</li>
  <li>Neural Networks and Statistical Learning</li>
</ul>


  </article>

</div>

<ul>



  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'httpdada889githubio'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>






</ul>

      </div>
    </div>



  </body>

</html>
