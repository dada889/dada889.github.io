<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Digit Recognizer by Neural Network</title>
    <meta name="description" content="This blog power by Github and Jekyll.
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://dada889.github.io/2014/12/NN.html">
</head>


  <body>

    <header class="site-header">


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
                  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
                          });
</script>
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <div class="wrapper">

    <a class="site-title" href="/">Nothing About Data</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
          <a class="page-link" href="/Archive">Archive</a>
          <a class="page-link" href="/Categories">Categories</a>
	  <a class="page-link" href="/about">About</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Digit Recognizer by Neural Network</h1>
    <p class="post-meta">Dec 2, 2014</p>
  
    <ul class="tag_box inline">
      
      


  
     
    	<li><a href="/Tags#neural network-ref">neural network <span>1</span></a></li>
     
    	<li><a href="/Tags#machine learning-ref">machine learning <span>1</span></a></li>
     
    	<li><a href="/Tags#kaggle-ref">kaggle <span>1</span></a></li>
    
  




    </ul>
  
  </header>
  


  <article class="post-content">
    <h3 id="intorduction">Intorduction</h3>
<p>This algorithm is for a <a href="https://www.kaggle.com/c/digit-recognizer">kaggle competition</a> to take an image of a handwritten single digit, and determine what that digit is. The data used is <a href="https://www.kaggle.com/c/digit-recognizer/data">MNIST data</a>.     </p>

<p>The trainning data include 42000 image of hand-drawn digits. Each image is 28 pixels in height and 28 pixels in width, for a total of 784 pixels in total.  </p>

<p>Here is the data for handwritten 1:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">sample_data <span class="o">&lt;-</span> read.csv<span class="p">(</span><span class="s">&quot;train.csv&quot;</span><span class="p">,</span> header<span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span>nrows<span class="o">=</span><span class="m">10</span><span class="p">)</span>
<span class="kt">matrix</span><span class="p">(</span>sample_data<span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="m">-1</span><span class="p">],</span><span class="m">28</span><span class="p">,</span><span class="m">28</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">##       [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12]
##  [1,] 0    0    0    0    0    0    0    0    0    0     0     0    
##  [2,] 0    0    0    0    0    0    0    0    0    0     0     0    
##  [3,] 0    0    0    0    0    0    0    0    0    0     0     0    
##  [4,] 0    0    0    0    0    0    0    0    0    0     0     0    
##  [5,] 0    0    0    0    0    0    0    0    0    0     0     0    
##  [6,] 0    0    0    0    0    0    0    0    0    0     0     0    
##  [7,] 0    0    0    0    0    0    0    0    0    0     0     0    
##  [8,] 0    0    0    0    0    0    0    0    0    0     0     0    
##  [9,] 0    0    0    0    0    0    0    0    0    0     0     0    
## [10,] 0    0    0    0    0    0    0    0    0    0     0     0    
## [11,] 0    0    0    0    0    0    0    0    0    0     0     0    
## [12,] 0    0    0    0    0    0    0    0    0    0     0     0    
## [13,] 0    0    0    0    0    0    0    0    0    0     0     0    
## [14,] 0    0    0    0    0    0    0    0    0    0     0     23   
## [15,] 0    0    0    0    0    0    0    0    0    0     93    210  
## [16,] 0    0    0    0    0    0    0    0    0    54    254   254  
## [17,] 0    0    0    0    0    0    0    0    29   209   253   253  
## [18,] 0    0    0    0    0    0    0    80   207  253   238   159  
## [19,] 0    0    0    0    0    0    123  247  253  253   170   0    
## [20,] 0    0    0    0    0    191  248  253  235  88    17    0    
## [21,] 0    0    0    0    188  250  253  208  77   0     0     0    
## [22,] 0    0    0    0    255  253  167  13   0    0     0     0    
## [23,] 0    0    0    0    94   93   10   0    0    0     0     0    
## [24,] 0    0    0    0    0    0    0    0    0    0     0     0    
## [25,] 0    0    0    0    0    0    0    0    0    0     0     0    
## [26,] 0    0    0    0    0    0    0    0    0    0     0     0    
## [27,] 0    0    0    0    0    0    0    0    0    0     0     0    
## [28,] 0    0    0    0    0    0    0    0    0    0     0     0    
##       [,13] [,14] [,15] [,16] [,17] [,18] [,19] [,20] [,21] [,22]
##  [1,] 0     0     0     0     0     0     0     0     0     0    
##  [2,] 0     0     0     0     0     0     0     0     0     0    
##  [3,] 0     0     0     0     0     0     0     0     0     0    
##  [4,] 0     0     0     0     0     0     0     0     0     0    
##  [5,] 0     0     0     0     0     0     0     0     0     0    
##  [6,] 0     0     0     0     0     0     0     0     0     0    
##  [7,] 0     0     0     0     0     0     0     0     0     0    
##  [8,] 0     0     0     0     0     0     0     0     15    94   
##  [9,] 0     0     0     0     0     0     0     89    220   253  
## [10,] 0     0     0     0     0     22    103   240   253   253  
## [11,] 0     0     0     0     20    188   253   253   253   253  
## [12,] 0     0     20    168   203   253   253   195   80    94   
## [13,] 16    27    206   253   253   245   191   25    0     0    
## [14,] 209   253   254   253   248   93    0     0     0     0    
## [15,] 253   253   254   196   76    0     0     0     0     0    
## [16,] 254   254   198   7     0     0     0     0     0     0    
## [17,] 240   13    7     0     0     0     0     0     0     0    
## [18,] 81    0     0     0     0     0     0     0     0     0    
## [19,] 0     0     0     0     0     0     0     0     0     0    
## [20,] 0     0     0     0     0     0     0     0     0     0    
## [21,] 0     0     0     0     0     0     0     0     0     0    
## [22,] 0     0     0     0     0     0     0     0     0     0    
## [23,] 0     0     0     0     0     0     0     0     0     0    
## [24,] 0     0     0     0     0     0     0     0     0     0    
## [25,] 0     0     0     0     0     0     0     0     0     0    
## [26,] 0     0     0     0     0     0     0     0     0     0    
## [27,] 0     0     0     0     0     0     0     0     0     0    
## [28,] 0     0     0     0     0     0     0     0     0     0    
##       [,23] [,24] [,25] [,26] [,27] [,28]
##  [1,] 0     0     0     0     0     0    
##  [2,] 0     0     0     0     0     0    
##  [3,] 0     0     0     0     0     0    
##  [4,] 0     0     0     0     0     0    
##  [5,] 0     0     0     0     0     0    
##  [6,] 0     0     0     0     0     0    
##  [7,] 0     0     0     0     0     0    
##  [8,] 89    0     0     0     0     0    
##  [9,] 251   214   0     0     0     0    
## [10,] 253   218   0     0     0     0    
## [11,] 250   95    0     0     0     0    
## [12,] 131   0     0     0     0     0    
## [13,] 0     0     0     0     0     0    
## [14,] 0     0     0     0     0     0    
## [15,] 0     0     0     0     0     0    
## [16,] 0     0     0     0     0     0    
## [17,] 0     0     0     0     0     0    
## [18,] 0     0     0     0     0     0    
## [19,] 0     0     0     0     0     0    
## [20,] 0     0     0     0     0     0    
## [21,] 0     0     0     0     0     0    
## [22,] 0     0     0     0     0     0    
## [23,] 0     0     0     0     0     0    
## [24,] 0     0     0     0     0     0    
## [25,] 0     0     0     0     0     0    
## [26,] 0     0     0     0     0     0    
## [27,] 0     0     0     0     0     0    
## [28,] 0     0     0     0     0     0</code></pre></div>

<p>Letâ€™s visualize some sample data:     </p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kn">require</span><span class="p">(</span>graphics<span class="p">)</span>

flip <span class="o">=</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">)</span> <span class="p">{</span>
  xx<span class="o">=</span><span class="kt">matrix</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="kp">nrow</span><span class="p">(</span>x<span class="p">),</span><span class="kp">ncol</span><span class="p">(</span>x<span class="p">))</span>
  <span class="kr">for</span> <span class="p">(</span>i <span class="kr">in</span> <span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="kp">nrow</span><span class="p">(</span>x<span class="p">))){</span>
    xx<span class="p">[</span>i<span class="p">,]</span> <span class="o">=</span> <span class="kp">rev</span><span class="p">(</span>x<span class="p">[</span>i<span class="p">,])}</span>
  <span class="kr">return</span><span class="p">(</span>xx<span class="p">)}</span>

sample_plot <span class="o">=</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">,</span>n<span class="p">)</span> <span class="p">{</span>
  xx <span class="o">=</span> <span class="kt">list</span><span class="p">()</span>
  par<span class="p">(</span>mfrow<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="kp">sqrt</span><span class="p">(</span>n<span class="p">),</span> <span class="kp">sqrt</span><span class="p">(</span>n<span class="p">)),</span>mar<span class="o">=</span><span class="kp">rep</span><span class="p">(</span><span class="m">0.2</span><span class="p">,</span><span class="m">4</span><span class="p">))</span>
  <span class="kr">for</span> <span class="p">(</span>i <span class="kr">in</span> <span class="m">1</span><span class="o">:</span>n<span class="p">)</span> <span class="p">{</span>
    temp <span class="o">=</span> <span class="kp">as.numeric</span><span class="p">(</span>x<span class="p">[</span>i<span class="p">,])</span>
    temp <span class="o">=</span> <span class="kt">matrix</span><span class="p">(</span>temp<span class="p">,</span><span class="m">28</span><span class="p">,</span><span class="m">28</span><span class="p">)</span>
    xx<span class="p">[[</span>i<span class="p">]]</span> <span class="o">=</span> flip<span class="p">(</span>temp<span class="p">)</span>
    image<span class="p">(</span>z<span class="o">=</span>xx<span class="p">[[</span>i<span class="p">]],</span> col<span class="o">=</span>gray.colors<span class="p">(</span><span class="m">12</span><span class="p">),</span>xaxt<span class="o">=</span><span class="s">&#39;n&#39;</span><span class="p">,</span>yaxt<span class="o">=</span><span class="s">&#39;n&#39;</span><span class="p">,</span>ann<span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
  <span class="p">}}</span>

sample_p <span class="o">&lt;-</span> read.csv<span class="p">(</span><span class="s">&quot;train.csv&quot;</span><span class="p">,</span> header<span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span>nrows<span class="o">=</span><span class="m">100</span><span class="p">)</span>
sample_p <span class="o">=</span> sample_p<span class="p">[,</span><span class="m">-1</span><span class="p">]</span>
sample_plot<span class="p">(</span>sample_p<span class="p">,</span><span class="m">64</span><span class="p">)</span></code></pre></div>

<p><img src="/figure/source/2014-12-2-NN/unnamed-chunk-2-1.png" alt="plot of chunk unnamed-chunk-2" /> </p>

<h3 id="neural-network-algorithm">Neural Network Algorithm</h3>

<p>The General Neural Newwork model shows below:</p>

<script type="math/tex; mode=display">
z^{(l+1)} = a^{(l)}(\Theta^{(l)})^T 
</script>

<script type="math/tex; mode=display">
a^{(l+1)} = f_{\theta}(z^{(l+1)}) 
</script>

<p>Here is structure of one hidden layer  Neural Network(with 15 unit in the hidden layer):
<img src="tikz12.png" alt="NN graph" title="NN" /></p>

<p>For classification problem, we use Cross-entropy cost function:    </p>

<script type="math/tex; mode=display">
J(\Theta)= -\frac{1}{m}  \left[  \sum^m_i \sum^K_k y^{(i)}_{k}log f_\theta (z^{(i)})_{k}  
  + (1-y^{(i)}_k ) log( 1- f_\theta (z^{(i)})_{k} )  \right]     
</script>

<p>or the simple version:</p>

<script type="math/tex; mode=display">
J(\Theta)= -\frac{1}{m} \sum^m_i \sum^K_k y^{(i)}_{k}log f_\theta (z^{(i)})_{k}      
</script>

<p>From the cost function $J(\Theta)$, we have derivatives:</p>

<script type="math/tex; mode=display">
\frac{\partial J(\Theta)}{\partial \Theta^{(l)}} =  \frac{f_{\theta}(z^{(l+1)})}{\partial z^{(l+1)}} \frac{\partial z^{(l+1)}}{\partial \Theta^{(l)}}
</script>

<script type="math/tex; mode=display">
\frac{\partial J(\Theta)}{\partial \Theta^{(l)}} =  (y-f_{\theta}(z^{(l+1)}))^Ta^{l}
</script>

<p>Here is the R code for the neural network. This model include two hidden layers with 25 units in first hidden layer 16 units in second hidden layer. I  minimize $J(\Theta)$ by gradient descent, called back-propagation in the setting.    </p>

<div class="highlight"><pre><code class="language-r" data-lang="r">a1 <span class="o">=</span> <span class="kp">cbind</span><span class="p">(</span><span class="m">1</span><span class="p">,</span>data<span class="p">)</span>
  z2 <span class="o">=</span> a1<span class="o">%*%</span><span class="kp">t</span><span class="p">(</span>Theta1<span class="p">)</span>
  a2 <span class="o">=</span> <span class="kp">cbind</span><span class="p">(</span><span class="m">1</span><span class="p">,</span>sigmoid<span class="p">(</span>z2<span class="p">))</span> <span class="c1">#add the bias term</span>
  z3 <span class="o">=</span> a2<span class="o">%*%</span><span class="kp">t</span><span class="p">(</span>Theta2<span class="p">)</span>
  a3 <span class="o">=</span> <span class="kp">cbind</span><span class="p">(</span><span class="m">1</span><span class="p">,</span>sigmoid<span class="p">(</span>z3<span class="p">))</span> <span class="c1">#add the bias term</span>
  z4 <span class="o">=</span> a3<span class="o">%*%</span><span class="kp">t</span><span class="p">(</span>Theta3<span class="p">)</span>
  h <span class="o">=</span> sigmoid<span class="p">(</span>z4<span class="p">)</span>
  <span class="c1"># reshape the y</span>
  ny <span class="o">=</span> <span class="kt">matrix</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="kp">length</span><span class="p">(</span>y<span class="p">),</span>num_labels<span class="p">)</span>
  <span class="kr">for</span> <span class="p">(</span>i <span class="kr">in</span> <span class="m">1</span><span class="o">:</span><span class="kp">length</span><span class="p">(</span>y<span class="p">)){</span>
    ny<span class="p">[</span>i<span class="p">,</span>y<span class="p">[</span>i<span class="p">]]</span> <span class="o">=</span> <span class="m">1</span><span class="p">}</span>
  
  <span class="c1"># cost function</span>
  regu <span class="o">=</span> lambda<span class="o">*</span><span class="p">(</span><span class="kp">sum</span><span class="p">(</span>Theta1<span class="p">[,</span><span class="m">-1</span><span class="p">]</span><span class="o">^</span><span class="m">2</span><span class="p">)</span> <span class="o">+</span> <span class="kp">sum</span><span class="p">(</span>Theta2<span class="p">[,</span><span class="m">-1</span><span class="p">]</span><span class="o">^</span><span class="m">2</span><span class="p">)</span> <span class="o">+</span> <span class="kp">sum</span><span class="p">(</span>Theta3<span class="p">[,</span><span class="m">-1</span><span class="p">]</span><span class="o">^</span><span class="m">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="m">2</span><span class="o">*</span>m<span class="p">)</span>
  cost <span class="o">=</span> <span class="o">-</span><span class="kp">sum</span><span class="p">(</span>ny<span class="o">*</span><span class="kp">log</span><span class="p">(</span>h<span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="m">1</span><span class="o">-</span>ny<span class="p">)</span><span class="o">*</span><span class="kp">log</span><span class="p">(</span><span class="m">1</span><span class="o">-</span>h<span class="p">))</span><span class="o">/</span>m<span class="o">+</span>regu

  <span class="c1"># back propagation</span>
  delta4 <span class="o">=</span> h<span class="o">-</span>ny
  delta3 <span class="o">=</span> <span class="p">(</span>delta4<span class="o">%*%</span>Theta3<span class="p">[,</span><span class="m">-1</span><span class="p">])</span><span class="o">*</span>sigmoidGradient<span class="p">(</span>z3<span class="p">)</span>
  delta2 <span class="o">=</span> <span class="p">(</span>delta3<span class="o">%*%</span>Theta2<span class="p">[,</span><span class="m">-1</span><span class="p">])</span><span class="o">*</span>sigmoidGradient<span class="p">(</span>z2<span class="p">)</span>
  <span class="c1"># add the bias term</span>
  thres1 <span class="o">=</span> <span class="kt">matrix</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="kp">nrow</span><span class="p">(</span>Theta1<span class="p">),</span><span class="kp">ncol</span><span class="p">(</span>Theta1<span class="p">))</span>
  thres1<span class="p">[,</span><span class="m">1</span><span class="p">]</span> <span class="o">=</span> <span class="m">0</span>
  thres2 <span class="o">=</span> <span class="kt">matrix</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="kp">nrow</span><span class="p">(</span>Theta2<span class="p">),</span><span class="kp">ncol</span><span class="p">(</span>Theta2<span class="p">))</span>
  thres2<span class="p">[,</span><span class="m">1</span><span class="p">]</span> <span class="o">=</span> <span class="m">0</span>
  thres3 <span class="o">=</span> <span class="kt">matrix</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="kp">nrow</span><span class="p">(</span>Theta3<span class="p">),</span><span class="kp">ncol</span><span class="p">(</span>Theta3<span class="p">))</span>
  Theta1_grad <span class="o">=</span> <span class="p">(</span><span class="kp">t</span><span class="p">(</span>delta2<span class="p">)</span><span class="o">%*%</span>a1<span class="p">)</span><span class="o">/</span>m <span class="o">+</span> thres1<span class="o">*</span>Theta1<span class="o">*</span>lambda<span class="o">/</span>m
  Theta2_grad <span class="o">=</span> <span class="p">(</span><span class="kp">t</span><span class="p">(</span>delta3<span class="p">)</span><span class="o">%*%</span>a2<span class="p">)</span><span class="o">/</span>m <span class="o">+</span> thres2<span class="o">*</span>Theta2<span class="o">*</span>lambda<span class="o">/</span>m
  Theta3_grad <span class="o">=</span> <span class="p">(</span><span class="kp">t</span><span class="p">(</span>delta4<span class="p">)</span><span class="o">%*%</span>a3<span class="p">)</span><span class="o">/</span>m <span class="o">+</span> thres3<span class="o">*</span>Theta3<span class="o">*</span>lambda<span class="o">/</span>m</code></pre></div>


  </article>

</div>

<ul>



  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'httpdada889githubio'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>






</ul>

      </div>
    </div>



  </body>

</html>
